
> [!fact] 
> У нас есть две полноценные ОС, и глобально отличаются они только битом NS:  
> - Secure OS (TEE), NS=0;  
> - Non-Secure OS (гостевая, например, Linux), NS=1.

> [!security]
> Ведь логично, что гостевая ОС не может поменять себе бит NS и получить привилегии Secure? Абсолютно логично. Менее ожидаемо, что и Secure OS не может вот так взять и переключиться в режим Non-Secure, поменяв NS на 1. Но это тоже так.

## Переключение режимов

> [!warning]
> Дело в том, что переключение между режимами оказалось несколько сложнее, чем один бит поменять:
> - Для переключения между режимами нужно еще и сохранить/восстановить контекст. Почти все регистры у Secure и Non-secure общие, и их нужно сохранять и восстанавливать.  
> - Кроме того, обращение из Normal World в Secure World нужно, чтобы сделать какую-то операцию, а у операции обычно есть параметры и возвращаемое значение. Это тоже нужно учитывать.

Вот для этого и придумали режим Secure Monitor. Попадают туда с помощью вызова “SMC #0“, что расшифровывается как Secure Monitor call. Причем и Secure код должен вызывать “SMC #0“, чтобы переключиться в Non-Secure. И Non-Secure в Secure перепрыгивает также.

> [!finally] 
> В целом, вызов SMC подобен системному вызову операционной системы (SVC):  
> - системный вызов SVC позволяет приложению ОС из непривилегированного режима (PL0) вызвать функцию ОС (PL1);  
> - вызов монитора SMC позволяет коду гостевой ОС (Non-Secure PL1) вызвать функцию TEE (Secure PL1)


> [!important] 
> Три особенности режима Secure Monitor позволяют ему выполнять переключение контекста Secure/Non-Secure.  
  
> [!list]
> - У него есть свой собственный стек, относящийся к области памяти Secure. Стек доступен сразу по входу в режим Secure Monitor, и в него можно сразу сохранить все регистры (контекст) вызывающей стороны, причем неважно, какой.  
> - В режиме Secure Monitor мы можем изменять бит NS, как нам заблагорассудится.  
> - Меняя бит NS в режиме Secure Monitor, мы можем видеть регистры и периферию то из режима Secure, то из режима Non-Secure. NS при этом будет реально меняться, и это отразится на работе всей аппаратной обвязки. Однако все это будет в рамках выполнения одной последовательной подпрограммы. Благодаря этому Secure Monitor может подготовить все необходимое для переключения контекста.

