> [!important]
> Давайте уточним и скорректируем некоторые детали процесса компиляции в ART (Android Runtime):

1. **Первоначальная установка приложения:**
    
    - При установке приложения через Play Store может быть включен файл метаданных DEX (.dm), который содержит **облачный профиль**. Облачный профиль — это заранее собранный профиль использования приложения, основанный на данных использования с других устройств. Этот профиль содержит информацию о методах, которые наиболее часто используются.
    - ART выполняет **AOT-компиляцию (Ahead-Of-Time)** методов, перечисленных в облачном профиле, чтобы ускорить запуск и работу приложения. Если приложение установлено без файла метаданных DEX, то начальная AOT-компиляция не выполняется, и все методы остаются интерпретируемыми.
2. **Первые запуски приложения:**
    
    - Методы, которые не были скомпилированы с помощью AOT, интерпретируются.
    - Среди этих интерпретируемых методов те, которые часто вызываются, компилируются **JIT (Just-In-Time)** во время выполнения приложения.
    - ART генерирует **локальный профиль** на основе использования приложения на устройстве, который объединяется с облачным профилем (если он существует). Этот локальный профиль помогает определить, какие методы наиболее важны для производительности на конкретном устройстве.
3. **Компиляция во время простоя:**
    
    - Когда устройство простаивает и заряжается, **демон компиляции** запускается и выполняет повторную компиляцию приложения на основе объединенного профиля (облачного и локального). Эта компиляция производится AOT и охватывает больше методов, чем начальная установка, включая те, которые были определены как часто используемые в процессе JIT-компиляции.
    - Таким образом, постепенно все больше кода приложения переводится из интерпретируемого или JIT-состояния в AOT-состояние, улучшая производительность.
4. **Последующие запуски приложения:**
    
    - При последующих запусках ART использует [[Артефакты]], сгенерированные демоном компиляции, которые содержат больше кода, скомпилированного с помощью AOT.
    - Методы, которые не были скомпилированы AOT, продолжают интерпретироваться или JIT-компилироваться в зависимости от их использования.
    - ART обновляет локальный профиль на основе текущего выполнения, что позволяет демону компиляции использовать эту информацию для дальнейшей оптимизации при последующих запусках.



> [!finally] Very Important
> ART состоит из компилятора (инструмента `dex2oat`) и среды выполнения (`libart.so`), которая загружается во время загрузки. Инструмент `dex2oat` берет APK-файл и генерирует один или несколько файлов [[Артефакты|артефактов]] компиляции, которые загружаются средой выполнения. Количество файлов, их расширения и имена могут меняться в разных версиях, но начиная с версии Android 8 эти файлы создаются:
> - `.vdex`: содержит некоторые дополнительные метаданные для ускорения проверки, иногда вместе с несжатым DEX-кодом APK. 
> - `.odex`: содержит скомпилированный AOT код для методов в APK.
> - `.art (optional)` содержит внутренние представления ART некоторых строк и классов, перечисленных в APK, используемые для ускорения запуска приложения.

## Опции конфигурации

> [!fact] 
> Существует две категории опций компиляции для ART:
> - System ROM configuration: какой код компилируется в AOT при сборке образа системы.
> - Runtime configuration: как ART компилирует и запускает приложения на устройстве.

### Фильтры компилятора

Одним из основных вариантов ART для настройки этих двух категорий являются _фильтры компилятора_. Фильтры компилятора управляют тем, как ART компилирует код DEX, и являются опцией, передаваемой инструменту `dex2oat`. Начиная с Android 8, есть четыре официально поддерживаемых фильтра:

- `verify`: запускать только проверку DEX-кода (без компиляции AOT).
- ~~`quicken`: (до Android 11) запустите проверку кода DEX и оптимизируйте некоторые инструкции DEX для повышения производительности интерпретатора.~~
- `speed`: Запустите проверку DEX-кода и AOT-компиляцию всех методов.
- `speed-profile`: Запустите методы проверки кода DEX и AOT-компиляции, перечисленные в файле профиля.

### System ROM configuration

Предустановленные библиотеки и приложения компилируются методом AOT при сборке образа системы. Этот процесс называется _dexpreopt_. Такие скомпилированные файлы можно использовать до тех пор, пока все зависимости остаются неизменными, в частности путь к классам загрузки.

