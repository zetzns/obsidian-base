
> [!new] 
> Приложения Android, подписанные одним и тем же ключом, могут запросить возможность работать под одним UID, а также, опционально, в рамках одного процесса. Такая функция называется **`Shared User ID`** и широко используется основными сервисами фреймворка и системными приложениями.

Поскольку это может оказывать тонкое влияние на учет процессов и управление приложениями, команда Android не рекомендует использовать это для сторонних приложений, но оно доступно также для приложений, установленных пользователем.

> [!fact] 
> Кроме того, изменение существующего приложения, которое не пользуется Shared UID на использование такового ***не поддерживается***, поэтому кооперирующие приложения, желающие использовать такую функцию, должны быть выпущены вместе с ней с самого начала.

Shared User ID включается путем добавления атрибута `sharedUserId` к корневому элементу `AndroidManifest.xml`. Идентификатор пользователя, указанный в манифесте, должен быть в формате пакета Java (содержащем хотя бы одну точку `[.]`) и используется как идентификатор, аналогично именам пакетов для приложений.

> [!missing] 
> Если указанный Shared UID не существует, он создается. Если другой пакет с тем же Shared UID уже установлен, сравнивается сертификат подписи с сертификатом существующего пакета, и если они не совпадают, возвращается ошибка `INSTALL_FAILED_SHARED_USER_INCOMPATIBLE`, и установка не удается.

> [!warning] 
> Добавление атрибута `SharedUserId` к новой версии уже установленного приложения приведёт к изменению его UID, а значит и к потере доступа к его собственным файлам. Поэтому система запрещает это, отклоняя обновление с ошибкой `INSTALL_FAILED_UID_CHANGED`.

Shared UID сам по себе является объектом первого класса в базе данных пакетов системы и обрабатывается аналогично приложениям: он имеет ассоциированный сертификат(ы) подписи и разрешения. В Android есть пять встроенных Shared UID, которые автоматически добавляются при загрузке системы:

- android.uid.system (SYSTEM_UID, 1000)
- android.uid.phone (PHONE_UID, 1001)
- android.uid.bluetooth (BLUETOOTH_UID, 1002)
- android.uid.log (LOG_UID, 1007)
- android.uid.nfc (NFC_UID, 1027)

```xml
<shared-user name="android.uid.system" userId="1000">
    <sigs count="1">
        <cert index="4" />
    </sigs>
    <perms>
        <item name="android.permission.MASTER_CLEAR" />
        <item name="android.permission.CLEAR_APP_USER_DATA" />
        <item name="android.permission.MODIFY_NETWORK_ACCOUNTING" />
        <!-- другие разрешения -->
    </perms>
</shared-user>
```

Как видно, определение включает множество разрешений (около 66 на устройстве с Android 4.4), и оно очень похоже на объявления пакетов, показанные ранее.

> [!important] 
> Пакеты, которые являются частью Shared User ID, не имеют ассоциированного списка предоставленных разрешений. Вместо этого они наследуют разрешения Shared User ID, которые являются объединением разрешений, запрашиваемых всеми установленными в данный момент пакетами с тем же Shared User ID. Одним из побочных эффектов этого является то, что если пакет является частью Shared User ID, он может получить доступ к API, для которых он не запрашивал разрешения, при условии, что какой-либо пакет с тем же Shared User ID уже запросил их.

Декларация пакета системного приложения, использующего Shared User ID

```xml
<package name="com.android.keychain"
    codePath="/system/app/KeyChain.apk"
    nativeLibraryPath="/data/app-lib/KeyChain"
    flags="540229" ft="13cd65721a0"
    it="13c2d4721f0" ut="13cd65721a0"
    version="19"
    sharedUserId="1000">
    <sigs count="1">
        <cert index="4" />
    </sigs>
    <signing-keyset identifier="1" />
</package>
```

Приложения, работающие под одним и тем же Shared UID (system)

![[Pasted image 20240707224025.png]]

Приложения, которые являются частью Shared User ID, могут работать в одном процессе. Поскольку они уже имеют тот же UID Linux и могут получить доступ к тем же системным ресурсам, это обычно не требует дополнительных модификаций. Общий процесс может быть запрошен, указав одно и то же имя процесса в атрибуте `process` тега `<application>` в манифестах всех приложений, которые должны работать в одном процессе.

---
---
Следующая глава [[Пользовательские Разрешения]]
Предыдущая глава [[Системные Разрешения]]
Раздел [[Permissions]]
Книга [[SEC Internals]]
