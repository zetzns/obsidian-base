
> [!example] 
> Ансамблевый поиск (Ensemble Retrieval):

```python
def ensemble_search(query, weight_semantic=0.7, weight_keyword=0.3):
    # Семантический поиск
    semantic_results = vector_db.search(embed_text(query))
    
    # Поиск по ключевым словам
    keyword_results = elasticsearch.search(query)
    
    # Комбинирование с помощью Reciprocal Rank Fusion
    combined_scores = {}
    
    for i, result in enumerate(semantic_results):
        combined_scores[result.id] = weight_semantic / (i + 1)
    
    for i, result in enumerate(keyword_results):
        if result.id in combined_scores:
            combined_scores[result.id] += weight_keyword / (i + 1)
        else:
            combined_scores[result.id] = weight_keyword / (i + 1)
    
    # Сортировка по итоговому счёту
    return sorted(combined_scores.items(), key=lambda x: x[1], reverse=True)
```

> [!example] 
> Оптимизация контекстного окна

```python
def assemble_context(retrieved_chunks, max_tokens=4000):
    context_parts = []
    current_tokens = 0
    
    # Сортируем по релевантности
    sorted_chunks = sorted(retrieved_chunks, key=lambda x: x.score, reverse=True)
    
    for chunk in sorted_chunks:
        chunk_tokens = count_tokens(chunk.text)
        if current_tokens + chunk_tokens <= max_tokens:
            context_parts.append({
                'text': chunk.text,
                'source': chunk.metadata.get('source', ''),
                'page': chunk.metadata.get('page_number', '')
            })
            current_tokens += chunk_tokens
        else:
            break
    
    return context_parts
```

